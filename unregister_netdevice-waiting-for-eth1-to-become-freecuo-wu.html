<!--processed for each article-->
<!DOCTYPE html>
<html lang="zh">
<head>
    <title>unregister_netdevice: waiting for eth1 to become free？错误 - Windeal's Home</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!--上述3个meta标签**必须**放在前面，任何其他内容都**必须**跟随其后-->

        <meta name="author" content="Windeal.Li" />
        <meta name="keywords" content="Linux,网络，内核" />
        <meta name="description" content="然后因为要做Vlan-tag的功能，在实现过程中需要重新配置vlan，（问题主要在其中一部需要删除eth1，是通过vconfig rem eth1删除的),但是在执行这条删除命令的时候出现了标题所示的错误： unregister_netdevice: waiting for eth1 to become free？，然后板子就宕掉了 前段日子在做vlan的时候遇见一个麻烦，问题大致是这样的：" />

    <!-- Bootstrap -->
		<!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
		<!-- Bootstrap theme -->
		<link href="/theme/css/bootstrap-theme.min.css" rel="stylesheet">

	<!--百度统计-->
<!--百度统计-->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ebe135bbd1292a4b3b8d4a0b3406c42a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
	<!--百度站长平台-->
	<meta name="baidu-site-verification" content="GYyFYVIoFx" />
	

</head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <a href="/" class="navbar-brand">
Windeal's Home            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/">我的博客</a></li>
                    <li><a href="/categories.html">分类目录</a></li>
                    <li><a href="/pages/aboutme.html">关于博主</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav> <!-- /.navbar -->


<div class="container theme=showcase" role='main' style="margin-top:50px;">
    <div class="row">
		<div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/unregister_netdevice-waiting-for-eth1-to-become-freecuo-wu.html"
                       rel="bookmark"
                       title="Permalink to unregister_netdevice: waiting for eth1 to become free？错误">
                        unregister_netdevice: waiting for eth1 to become free？错误
                    </a>
                </h1>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        Windeal.Li
    </span>
  </span>
  <time datetime="2015-11-29T00:00:00+08:00" pubdate>
	  Sun 29 November 2015
  </time>
  <span class="categories"><a class='category' href='/category/bugs.html'>bugs</a>
  </span>
  <span class="categories">
    <a class="category" href="/tag/linux.html">Linux</a>,    <a class="category" href="/tag/wang-luo-nei-he.html">网络，内核</a>  </span>
</p>            </header>
            <div class="entry-content">
                <h2>Description：</h2>
<div class="highlight"><pre><span></span>路由器仅有一张网卡，phy0，通过vlan划分WAN端和LAN端
</pre></div>


<div class="highlight"><pre><span></span>    vconfig add phy0 1  #lan phy0.1
    vconfig add phy0 2 #wan phy0.2，（我通过ip link改了名字，使得phy0.2 更名为eth1）
</pre></div>


<p>然后因为要做Vlan-tag的功能，在实现过程中需要重新配置vlan，（问题主要在其中一部需要删除eth1，是通过vconfig rem eth1删除的),但是在执行这条删除命令的时候出现了标题所示的错误：
unregister_netdevice: waiting for eth1 to become free？，然后板子就宕掉了。</p>
<div class="highlight"><pre><span></span>碰上问题时，进行了些分析，其间走了不少弯路，这里也顺便提下走的弯路了。
</pre></div>


<h2>Analyse 1：</h2>
<div class="highlight"><pre><span></span>应该是由程序占用了eth1，那么，先找出占用它的程序。
首先看了下所有正在运行的进程，kill掉比较可能的进程，rmmod掉可能占用eth1的模块（包括一个名为enet的模块，这里先提一下，因为最后分析出来其实是enet模块导致了这个错误）。结果执行vconfig rem eth1 命令还是会出现错误，并宕机。
接着通过循环，kill掉所有能kill掉的进程，问题依然没有解决。
</pre></div>


<h2>Analyse 2：</h2>
<div class="highlight"><pre><span></span>查资料，发现错误现象应该是：eth1设备的引用计数不为0，导致eth1的除名函数在netdev_run_todo中陷入死循环（循环判断eth1的引用计数是否为0），然后导致程序宕机。
乍一看，跟Analyse1 的分析结果差不多，其实不然。
 其主要区别在于：
    在Analyse 1中，我们认为，eth1是否程序占用了，那么我们把程序down/kill掉，就可以解除占用。而在Analyse 2中，eth1引用计数不为0，不一定是eth1被占用了，也可能因为占用它的程序/模块在自身down掉的时候，没有吧引用计数减一造成的。
在网上查了好久，出现unregister_netdevice: waiting for eth1 to become free？的原因可能是某一处代码中使用了dev_hold而没有使用dev_put。
dev_hold和dev_put是配对使用的，一个用来引用计数加一，一个用于引用计数减一。
查看模块代码，没有发现单独直接使用dev_hold的情况。那会不会是简介调用呢，仔细查找了好久，果然是间接调用。
在我们一些模块代码中，经常会通过dev_get_by_name来获取设备信息。而dev_get_by_name封装了dev_hold，导致引用计数加一。由于dev_get_by_name是内核提供的接口，不熟悉的coder很可能不晓得这点，也没有注意到需要调用dev_put.，于是便有了上面所说的错误。
</pre></div>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>
	
<!--邻居导航-->
<section>
 <ul>
     <li> 上一篇：
         <a href="/ioctl-huo-qu-wang-luo-jie-kou-xin-xi.html">
             ioctl 获取网络接口信息
         </a>
     </li>
     <li> 下一篇：
         <a href="/gccsheng-ji-dao-jian-dan-fang-fa.html">
             gcc升级到简单方法
         </a>
     </li>
</ul>
</section>
   <!--页面主题内容-->
        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div>

<section>
<h2>最新文章</h2>
<ul id="recent_posts">
  <li class="post">
	  <a href="/gccsheng-ji-dao-jian-dan-fang-fa.html">gcc升级到简单方法</a>
  </li>
  <li class="post">
	  <a href="/unregister_netdevice-waiting-for-eth1-to-become-freecuo-wu.html">unregister_netdevice: waiting for eth1 to become free？错误</a>
  </li>
  <li class="post">
	  <a href="/ioctl-huo-qu-wang-luo-jie-kou-xin-xi.html">ioctl 获取网络接口信息</a>
  </li>
  <li class="post">
	  <a href="/wu-xian-maczheng-xiang-jie.html">无线MAC帧详解</a>
  </li>
</ul>
</section><!--相关文章-->

<section>
	<h2>相关文章</h2>
    <ul id="related_posts">
        <li class="posts">
			<a href="/ioctl-huo-qu-wang-luo-jie-kou-xin-xi.html">ioctl 获取网络接口信息</a>
		</li>
    </ul>
</section>


</div>            </aside>
        </div>
    </div>

<!--页面底部-->

<footer class='footer' style="margin-top:100px">
  <p>
		Copyright &copy;  2015&ndash;2017  Windeal
  </p>
</footer></div>

	<!--百度站长平台-->
<!--百度站长-->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
	<script src="/theme/js/bootstrap.js"></script>
	<script src="/theme/js/bootstrap.min.js"></script>
	<script src="/theme/js/npm.js"></script>

</body>
</html>
